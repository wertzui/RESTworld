<p-table
  #table
  [value]="rows"
  [columns]="columns"
  [lazy]="true"
  [lazyLoadOnInit]="false"
  (onLazyLoad)="load($event)"
  responsiveLayout="scroll"
  [paginator]="true"
  [rowsPerPageOptions]="rowsPerPageOptions"
  [rows]="rows.length"
  [totalRecords]="totalRecords"
  [loading]="isLoading"
  sortMode="multiple"
  [multiSortMeta]="multiSortMeta"
  [styleClass]="styleClass"
  [tableStyle]="tableStyle"
  [scrollable]="scrollable"
  [scrollHeight]="scrollHeight"
  [selectionMode]="selectionMode"
  (onRowSelect)="onRowSelectInternal($event)"
  (onRowUnselect)="onRowUnselectInternal($event)"
  [rowHover]="rowHover"
  [(selection)]="_selection"
  (selectionChange)="onSelectionChangeInternal($event)">

  <ng-template pTemplate="header" let-columns>
    <tr>
        <th *ngFor="let col of columns" [pSortableColumn]="col.name">
            <div class="p-d-flex p-jc-between p-ai-center">
                {{col.prompt}}
                <ng-container *ngIf="!col.readOnly">
                  <p-sortIcon [field]="col.name"></p-sortIcon>
                  <p-columnFilter [type]="toColumnFilterType(col.type)" [matchMode]="toMatchMode(col.type)" [field]="col.name" display="menu"></p-columnFilter>
                </ng-container>
            </div>
        </th>
        <th *ngIf="showMenuColumn" class="flex justify-content-end">
          <rw-menu-button [items]="headerMenu"></rw-menu-button>
        </th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-entity let-columns="columns" let-rowIndex="rowIndex">
    <tr (contextmenu)="openContextMenu($event, entity)" [pSelectableRow]="entity" [pSelectableRowDisabled]="selectionMode === null" [className]="rowStyleClasses[rowIndex - (table.first ?? 0)]">
      <td [ngSwitch]="col.type" *ngFor="let col of columns" [className]="cellStyleClasses[rowIndex - (table.first ?? 0)][col.name]">
          <ng-container *ngIf="showInputField(col); else textField" [formGroup]="formArray!.controls[rowIndex - (table.first ?? 0)]" >
            <rw-input [apiName]="apiName!" [property]="editProperties[col.name]"></rw-input>
          </ng-container>
          <ng-template #textField>
            <ng-container *ngSwitchCase="PropertyType.Text">
                <rw-avatar *ngIf="col.name === 'createdBy' || col.name === 'lastChangedBy'" [user]="entity[col.name]"></rw-avatar>
                <span *ngIf="col.name !== 'createdBy' && col.name !== 'lastChangedBy'">{{entity[col.name]}}</span>
            </ng-container>
            <span *ngSwitchCase="PropertyType.Number" class="flex justify-content-end">{{entity[col.name] | propertyTypeFormat:col.type}}</span>
            <span *ngSwitchCase="PropertyType.Percent" class="flex justify-content-end">{{entity[col.name] | propertyTypeFormat:col.type}}</span>
            <span *ngSwitchCase="PropertyType.Currency" class="flex justify-content-end">{{entity[col.name] | propertyTypeFormat:col.type}}</span>
            <span *ngSwitchCase="PropertyType.Bool" class="flex justify-content-center"><p-triStateCheckbox [(ngModel)]="entity[col.name]" [readonly]="true"></p-triStateCheckbox></span>
            <span *ngSwitchCase="PropertyType.Date" [pTooltip]="entity[col.name]">{{entity[col.name] | propertyTypeFormat:col.type}}</span>
            <span *ngSwitchCase="PropertyType.Time" [pTooltip]="entity[col.name]">{{entity[col.name] | propertyTypeFormat:col.type}}</span>
            <span *ngSwitchCase="PropertyType.Duration" [pTooltip]="entity[col.name]">{{entity[col.name] | propertyTypeFormat:col.type}}</span>
            <span *ngSwitchCase="PropertyType.DatetimeLocal" [pTooltip]="entity[col.name]">{{entity[col.name] | propertyTypeFormat:PropertyType.Date}}</span>
            <span *ngSwitchCase="PropertyType.DatetimeOffset" [pTooltip]="entity[col.name]">{{entity[col.name] | propertyTypeFormat:PropertyType.Date}}</span>
            <span *ngSwitchCase="PropertyType.Collection" class="flex justify-content-end"><p *ngFor="let arrayElement of entity[col.name]">{{arrayElement | json}}</p></span>
            <span *ngSwitchCase="PropertyType.Object" class="flex justify-content-end">{{entity[col.name] | json}}</span>
            <span *ngSwitchDefault [pTooltip]="entity[col.name]">{{entity[col.name] | propertyTypeFormat:col.type}}</span>
          </ng-template>
        </td>
        <td *ngIf="showMenuColumn" class="flex justify-content-end">
          <rw-menu-button *ngIf="showRowMenuAsColumn" [items]="rowMenus[rowIndex - (table.first ?? 0)]"></rw-menu-button>
        </td>
    </tr>
  </ng-template>

  <p-contextMenu #contextMenu appendTo="body" [model]="contextMenuItems"></p-contextMenu>
</p-table>
